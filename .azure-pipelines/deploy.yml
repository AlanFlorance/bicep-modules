trigger: none
pr: none

resources:
  pipelines:
  - pipeline: bicep-modules.Validate
    source: bicep-modules.Validate
    trigger:
      branches:
        include:
        - main

schedules:
  - cron: "0 3 * * 0"
    displayName: Weekly Build
    branches:
      include:
      - main

pool: 'Dedicated'

stages:
- stage: ValidateBicep
  jobs: 
  - job: LintCode
    displayName: Lint Code
    steps:
      - task: AzureCLI@2
        name: LintBicepCode
        displayName: Run Bicep Linter
        inputs:
          azureSubscription: 'spn-ado-Personal-Public-bicep-modules'
          scriptType: 'pscore'
          scriptLocation: 'inlineScript'
          inlineScript: |
            $files = Get-ChildItem '$(Build.sourcesDirectory)/modules/*.bicep'

            foreach ($file in $files) {
              Write-Host "Publishing module '$($file.Name)'"

              $fileShortName = $file.Name

              $publishName = $($fileShortName.Substring(0, $fileShortName.length - 6)).toLower()
              az bicep publish --file $file.FullName --target "br:acrmxplatformprduksouth.azurecr.io/bicep/modules/$publishName:V$(Build.BuildId)"
            }
